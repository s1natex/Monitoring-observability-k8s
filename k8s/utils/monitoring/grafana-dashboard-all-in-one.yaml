apiVersion: v1
kind: ConfigMap
metadata:
  name: app-all-in-one-dashboard
  namespace: utils
  labels:
    grafana_dashboard: "1"   # <- kube-prometheus-stack sidecar watches this
data:
  app-all-in-one.json: |
    {
      "title": "App – All-in-One (Traffic • Errors • Latency • Saturation)",
      "timezone": "browser",
      "schemaVersion": 39,
      "version": 1,
      "refresh": "5s",
      "tags": ["app","demo","RED","USE"],
      "templating": {
        "list": [
          {
            "type": "query",
            "name": "service",
            "label": "Service",
            "datasource": {"type":"prometheus","uid":"prometheus"},
            "query": "label_values(http_requests_total, service)",
            "refresh": 1,
            "includeAll": true
          },
          {
            "type": "interval",
            "name": "rate",
            "label": "Rate window",
            "query": "15s,30s,1m,2m,5m",
            "current": {"text":"1m","value":"1m"}
          }
        ]
      },
      "panels": [
        {
          "type": "stat",
          "title": "RPS (total)",
          "gridPos": {"x":0,"y":0,"w":6,"h":4},
          "targets": [
            { "expr": "sum(rate(http_requests_total[$rate]))" }
          ],
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] } }
        },
        {
          "type": "stat",
          "title": "5xx Error % (overall)",
          "gridPos": {"x":6,"y":0,"w":6,"h":4},
          "fieldConfig": {"defaults":{"unit":"percent","decimals":2}},
          "targets": [
            {
              "expr": "(sum(rate(http_requests_total{status=~\"5..\"}[$rate])) / sum(rate(http_requests_total[$rate]))) * 100"
            }
          ],
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] } }
        },
        {
          "type": "stat",
          "title": "p95 latency (s) overall",
          "gridPos": {"x":12,"y":0,"w":6,"h":4},
          "fieldConfig": {"defaults":{"unit":"s","decimals":3}},
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum by (le) (rate(http_request_duration_seconds_bucket[$rate])))"
            }
          ],
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] } }
        },
        {
          "type": "stat",
          "title": "In-flight (max across services)",
          "gridPos": {"x":18,"y":0,"w":6,"h":4},
          "targets": [
            { "expr": "max(in_flight_requests)" }
          ],
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] } }
        },

        {
          "type": "timeseries",
          "title": "RPS by service",
          "gridPos": {"x":0,"y":4,"w":12,"h":8},
          "targets": [
            { "expr": "sum by (service) (rate(http_requests_total[$rate]))" }
          ]
        },
        {
          "type": "timeseries",
          "title": "HTTP status ratio (%) by service",
          "gridPos": {"x":12,"y":4,"w":12,"h":8},
          "fieldConfig": {"defaults":{"unit":"percent","decimals":1}},
          "options":{"legend":{"displayMode":"table"}},
          "targets": [
            {
              "expr": "100 * sum by (service,status) (rate(http_requests_total[$rate])) / ignoring(status) group_left sum by (service) (rate(http_requests_total[$rate]))"
            }
          ]
        },

        {
          "type": "timeseries",
          "title": "Latency p50/p90/p95/p99 (s) by service",
          "gridPos": {"x":0,"y":12,"w":12,"h":8},
          "fieldConfig":{"defaults":{"unit":"s","decimals":3}},
          "targets": [
            { "expr": "histogram_quantile(0.50, sum by (service, le) (rate(http_request_duration_seconds_bucket[$rate])))", "legendFormat":"{{service}} p50" },
            { "expr": "histogram_quantile(0.90, sum by (service, le) (rate(http_request_duration_seconds_bucket[$rate])))", "legendFormat":"{{service}} p90" },
            { "expr": "histogram_quantile(0.95, sum by (service, le) (rate(http_request_duration_seconds_bucket[$rate])))", "legendFormat":"{{service}} p95" },
            { "expr": "histogram_quantile(0.99, sum by (service, le) (rate(http_request_duration_seconds_bucket[$rate])))", "legendFormat":"{{service}} p99" }
          ]
        },
        {
          "type": "heatmap",
          "title": "Request duration histogram (overall)",
          "gridPos": {"x":12,"y":12,"w":12,"h":8},
          "targets": [
            { "expr": "sum by (le) (rate(http_request_duration_seconds_bucket[$rate]))" }
          ],
          "fieldConfig":{"defaults":{"unit":"s"}}
        },

        {
          "type": "timeseries",
          "title": "In-flight requests (saturation) by service",
          "gridPos": {"x":0,"y":20,"w":12,"h":8},
          "targets": [
            { "expr": "max by (service) (in_flight_requests)" }
          ]
        },
        {
          "type": "timeseries",
          "title": "5xx error rate by service",
          "gridPos": {"x":12,"y":20,"w":12,"h":8},
          "targets": [
            { "expr": "sum by (service) (rate(http_requests_total{status=~\"5..\"}[$rate]))" }
          ]
        },

        {
          "type": "timeseries",
          "title": "Pods CPU / Memory (app ns)",
          "gridPos": {"x":0,"y":28,"w":12,"h":8},
          "fieldConfig":{"defaults":{"unit":"bytes"}},
          "targets": [
            { "expr": "sum by (pod) (container_memory_working_set_bytes{namespace=\"app\",container!=\"\",image!=\"\"})", "legendFormat":"{{pod}} mem" },
            { "expr": "sum by (pod) (rate(container_cpu_usage_seconds_total{namespace=\"app\",container!=\"\",image!=\"\"}[1m]))", "legendFormat":"{{pod}} cpu (cores)" }
          ]
        },
        {
          "type": "timeseries",
          "title": "HPA replicas & restarts",
          "gridPos": {"x":12,"y":28,"w":12,"h":8},
          "targets": [
            { "expr": "kube_deployment_status_replicas{namespace=\"app\"}", "legendFormat":"{{deployment}} replicas" },
            { "expr": "sum by (pod) (kube_pod_container_status_restarts_total{namespace=\"app\"})", "legendFormat":"{{pod}} restarts" }
          ]
        },

        {
          "type":"stat",
          "title":"Prometheus targets up (app-services)",
          "gridPos":{"x":0,"y":36,"w":6,"h":4},
          "targets":[
            { "expr": "sum(up{job=\"app-services\"})" }
          ]
        },
        {
          "type":"table",
          "title":"Recent 5xx (last 15m)",
          "gridPos":{"x":6,"y":36,"w":18,"h":8},
          "targets":[
            { "expr": "sum by (service, status) (increase(http_requests_total{status=~\"5..\"}[15m]))" }
          ],
          "options":{"showHeader": true}
        }
      ]
    }
